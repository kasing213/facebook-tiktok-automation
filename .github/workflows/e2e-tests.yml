name: E2E Tests for Beta

on:
  push:
    branches: [ main, develop, beta ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run tests daily at 2 AM UTC for continuous monitoring
    - cron: '0 2 * * *'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Test environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production
      test_suite:
        description: 'Test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - auth
          - subscription
          - payment-ocr
          - telegram
          - security
          - performance

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.12'

jobs:
  setup:
    name: Setup Test Environment
    runs-on: ubuntu-latest
    outputs:
      test-env: ${{ steps.set-env.outputs.environment }}
      base-url: ${{ steps.set-env.outputs.base_url }}
    steps:
      - name: Set environment variables
        id: set-env
        run: |
          if [ "${{ github.event.inputs.environment }}" = "production" ]; then
            echo "environment=production" >> $GITHUB_OUTPUT
            echo "base_url=https://facebooktiktokautomation.vercel.app" >> $GITHUB_OUTPUT
          else
            echo "environment=staging" >> $GITHUB_OUTPUT
            echo "base_url=http://localhost:5173" >> $GITHUB_OUTPUT
          fi

  backend-health:
    name: Backend Health Check
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check backend health
        run: |
          # Start backend in background for local testing
          if [ "${{ needs.setup.outputs.test-env }}" = "staging" ]; then
            uvicorn app.main:app --host 0.0.0.0 --port 8000 &
            sleep 10

            # Health check
            curl -f http://localhost:8000/health || exit 1
          fi

      - name: Check database connection
        env:
          DATABASE_URL: ${{ secrets.TEST_DATABASE_URL }}
        run: |
          python -c "
          import psycopg2
          import os
          try:
              conn = psycopg2.connect(os.getenv('DATABASE_URL'))
              print('Database connection successful')
              conn.close()
          except Exception as e:
              print(f'Database connection failed: {e}')
              exit(1)
          "

  frontend-e2e:
    name: Frontend E2E Tests
    runs-on: ubuntu-latest
    needs: [setup, backend-health]
    strategy:
      fail-fast: false
      matrix:
        browser: [chromium, firefox, webkit]
        test-suite:
          - auth
          - subscription
          - payment-ocr
          - telegram
          - security
        exclude:
          # Skip webkit for complex tests to save resources
          - browser: webkit
            test-suite: payment-ocr
          - browser: webkit
            test-suite: telegram

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright browsers
        working-directory: frontend
        run: npx playwright install --with-deps ${{ matrix.browser }}

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Start frontend server
        working-directory: frontend
        run: |
          npm run preview &
          npx wait-on http://localhost:5173 --timeout 30000

      - name: Run E2E tests
        working-directory: frontend
        env:
          BASE_URL: ${{ needs.setup.outputs.base-url }}
          CI: true
        run: |
          if [ "${{ github.event.inputs.test_suite }}" = "all" ] || [ "${{ github.event.inputs.test_suite }}" = "" ]; then
            npx playwright test --project=${{ matrix.browser }} e2e/tests/${{ matrix.test-suite }}.spec.ts
          elif [ "${{ github.event.inputs.test_suite }}" = "${{ matrix.test-suite }}" ]; then
            npx playwright test --project=${{ matrix.browser }} e2e/tests/${{ matrix.test-suite }}.spec.ts
          else
            echo "Skipping test suite ${{ matrix.test-suite }}"
            exit 0
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-report-${{ matrix.browser }}-${{ matrix.test-suite }}
          path: frontend/playwright-report/
          retention-days: 14

      - name: Upload test screenshots
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: screenshots-${{ matrix.browser }}-${{ matrix.test-suite }}
          path: frontend/test-results/
          retention-days: 7

  performance-tests:
    name: Performance Tests
    runs-on: ubuntu-latest
    needs: [setup, backend-health]
    if: github.event_name == 'schedule' || github.event.inputs.test_suite == 'performance' || github.event.inputs.test_suite == 'all'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install chromium

      - name: Run performance tests
        working-directory: frontend
        env:
          BASE_URL: ${{ needs.setup.outputs.base-url }}
          PERFORMANCE_MODE: true
        run: npx playwright test e2e/tests/performance.spec.ts --project=chromium

      - name: Generate performance report
        if: always()
        working-directory: frontend
        run: |
          echo "# Performance Test Results" > performance-report.md
          echo "Date: $(date)" >> performance-report.md
          echo "Environment: ${{ needs.setup.outputs.test-env }}" >> performance-report.md
          echo "" >> performance-report.md

          if [ -f "performance-metrics.json" ]; then
            echo "## Metrics" >> performance-report.md
            cat performance-metrics.json >> performance-report.md
          fi

      - name: Upload performance report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: performance-report
          path: frontend/performance-report.md
          retention-days: 30

  accessibility-tests:
    name: Accessibility Tests
    runs-on: ubuntu-latest
    needs: setup

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        working-directory: frontend
        run: |
          npm ci
          npm install -D @axe-core/playwright

      - name: Install Playwright
        working-directory: frontend
        run: npx playwright install chromium

      - name: Run accessibility tests
        working-directory: frontend
        run: |
          npx playwright test --config=playwright-accessibility.config.ts
        continue-on-error: true

      - name: Upload accessibility report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: accessibility-report
          path: frontend/accessibility-report/
          retention-days: 14

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

      - name: Run npm audit
        working-directory: frontend
        run: |
          npm audit --audit-level=high
        continue-on-error: true

  test-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [frontend-e2e, performance-tests, accessibility-tests, security-scan]
    if: always()

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4

      - name: Generate test summary
        run: |
          echo "# E2E Test Summary" > test-summary.md
          echo "Date: $(date)" >> test-summary.md
          echo "Commit: ${{ github.sha }}" >> test-summary.md
          echo "Branch: ${{ github.ref_name }}" >> test-summary.md
          echo "" >> test-summary.md

          echo "## Test Results" >> test-summary.md

          # Count test results
          TOTAL_TESTS=0
          PASSED_TESTS=0
          FAILED_TESTS=0

          for report in playwright-report-*/; do
            if [ -d "$report" ]; then
              echo "- $report: Found" >> test-summary.md
              TOTAL_TESTS=$((TOTAL_TESTS + 1))

              # Check if tests passed (simplified check)
              if [ -f "$report/index.html" ]; then
                PASSED_TESTS=$((PASSED_TESTS + 1))
              else
                FAILED_TESTS=$((FAILED_TESTS + 1))
              fi
            fi
          done

          echo "" >> test-summary.md
          echo "Total Test Suites: $TOTAL_TESTS" >> test-summary.md
          echo "Passed: $PASSED_TESTS" >> test-summary.md
          echo "Failed: $FAILED_TESTS" >> test-summary.md

          if [ $FAILED_TESTS -gt 0 ]; then
            echo "❌ Some tests failed" >> test-summary.md
            exit 1
          else
            echo "✅ All tests passed" >> test-summary.md
          fi

      - name: Upload test summary
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-summary
          path: test-summary.md
          retention-days: 30

      - name: Comment PR with test results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            if (fs.existsSync('test-summary.md')) {
              const summary = fs.readFileSync('test-summary.md', 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
            }

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [frontend-e2e, performance-tests]
    if: github.ref == 'refs/heads/develop' && success()
    environment: staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Deploy to staging environment
        run: |
          echo "Deploying to staging environment..."
          # Add actual staging deployment steps here

      - name: Run staging smoke tests
        run: |
          echo "Running staging smoke tests..."
          # Add staging verification tests

  beta-release:
    name: Beta Release
    runs-on: ubuntu-latest
    needs: [frontend-e2e, performance-tests, security-scan]
    if: github.ref == 'refs/heads/main' && success()
    environment: production

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Create beta release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: beta-${{ github.run_number }}
          release_name: Beta Release ${{ github.run_number }}
          body: |
            ## Beta Test Release

            This is an automated beta release for testing purposes.

            ### Test Coverage
            - ✅ Authentication & Authorization
            - ✅ Subscription Management
            - ✅ Payment OCR Verification
            - ✅ Telegram Bot Integration
            - ✅ Security & Tenant Isolation
            - ✅ Performance & Load Testing

            ### Beta Test Instructions
            1. Sign up at https://facebooktiktokautomation.vercel.app
            2. Test the invoice creation flow
            3. Try payment verification with OCR
            4. Connect Telegram for notifications
            5. Report any issues in GitHub

            ### Known Limitations
            - Email verification disabled (Railway SMTP restrictions)
            - Limited to 200 concurrent users
            - OCR confidence threshold set to 80%
          draft: false
          prerelease: true

      - name: Notify beta testers
        run: |
          echo "Notifying beta testers of new release..."
          # Add notification logic (email, Slack, Discord, etc.)
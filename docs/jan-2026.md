# January 2026 - Development Documentation

## Mock Invoice API Implementation (2026-01-05)

### Overview
Implemented a mock Invoice API backend for testing the full invoice system without requiring an external Invoice API service. All features are available as free tier for manual testing.

### Architecture

```
Frontend (React)                    Backend (FastAPI)
/dashboard/invoices/*       →    /api/integrations/invoice/*
                                          │
                           ┌──────────────┴──────────────┐
                           │    INVOICE_MOCK_MODE?       │
                           └──────────────┬──────────────┘
                                   │              │
                          true     │              │ false
                                   ▼              ▼
                           Mock Service      External API
                         (in-memory CRUD)    (proxy to URL)
```

### Files Created/Modified

| File | Action | Purpose |
|------|--------|---------|
| `app/core/config.py` | Modified | Added INVOICE_MOCK_MODE, INVOICE_TIER_ENFORCEMENT flags |
| `app/services/invoice_mock_service.py` | **Created** | In-memory CRUD + sample data + mock PDF/Export |
| `app/routes/integrations/invoice.py` | Modified | Switch between mock/real based on config |
| `app/main.py` | Modified | Seed mock data on startup if mock mode |
| `.env` | Modified | Added mock mode environment variables |

---

### Configuration Flags

**`app/core/config.py`** additions:
```python
# Invoice Mock Mode (for testing without external API)
INVOICE_MOCK_MODE: bool = Field(default=False, description="Use mock in-memory Invoice API instead of external service")
INVOICE_TIER_ENFORCEMENT: bool = Field(default=True, description="Enforce Pro tier for PDF/Export features (disable for testing)")
```

**Environment Variables:**
```env
# Enable mock in-memory Invoice API instead of external service
INVOICE_MOCK_MODE=true
# Disable tier enforcement for testing (all features available as free tier)
INVOICE_TIER_ENFORCEMENT=false
```

---

### Mock Service (`app/services/invoice_mock_service.py`)

**Features:**
- In-memory storage using module-level dictionaries
- Auto-generates UUIDs for new records
- Auto-calculates invoice totals from line items
- Sample data seeding on startup

**Data Structures:**
```python
_customers: Dict[str, Dict]  # Customer records
_invoices: Dict[str, Dict]   # Invoice records
_invoice_counter: int        # Auto-increment for invoice numbers
```

**Functions:**
| Function | Purpose |
|----------|---------|
| `list_customers()` | List all customers |
| `get_customer(id)` | Get customer by ID |
| `create_customer(data)` | Create new customer |
| `update_customer(id, data)` | Update existing customer |
| `delete_customer(id)` | Delete customer |
| `list_invoices(params)` | List invoices with optional filtering |
| `get_invoice(id)` | Get invoice by ID |
| `create_invoice(data)` | Create new invoice (auto-calc totals) |
| `update_invoice(id, data)` | Update existing invoice |
| `delete_invoice(id)` | Delete invoice |
| `generate_pdf(id)` | Generate minimal valid PDF bytes |
| `export_invoices(format)` | Export as CSV or XLSX placeholder |
| `get_stats()` | Calculate dashboard statistics |
| `seed_sample_data()` | Seed 5 customers + 5 invoices |

**Sample Data:**
- 5 customers: Acme Corporation, TechStart Inc, Global Traders Ltd, Local Shop, Premium Services
- 5 invoices with varied statuses: paid, pending, overdue, draft, cancelled

---

### API Endpoints

**Base URL:** `/api/integrations/invoice`

| Endpoint | Method | Auth | Description |
|----------|--------|------|-------------|
| `/health` | GET | No | Service health check |
| `/customers` | GET | JWT | List all customers |
| `/customers` | POST | JWT | Create customer |
| `/customers/{id}` | GET | JWT | Get customer by ID |
| `/customers/{id}` | PUT | JWT | Update customer |
| `/customers/{id}` | DELETE | JWT | Delete customer |
| `/invoices` | GET | JWT | List invoices |
| `/invoices` | POST | JWT | Create invoice |
| `/invoices/export` | GET | JWT | Export CSV/XLSX |
| `/invoices/{id}` | GET | JWT | Get invoice by ID |
| `/invoices/{id}` | PUT | JWT | Update invoice |
| `/invoices/{id}` | DELETE | JWT | Delete invoice |
| `/invoices/{id}/pdf` | GET | JWT | Download PDF |
| `/stats` | GET | JWT | Dashboard statistics |

**Important:** `/invoices/export` must be defined BEFORE `/invoices/{id}` in the router to prevent route conflicts.

---

### Startup Behavior

**`app/main.py`** lifespan:
```python
# Seed mock invoice data if in mock mode
if s.INVOICE_MOCK_MODE:
    from app.services import invoice_mock_service
    result = invoice_mock_service.seed_sample_data()
    if result.get("seeded"):
        log.info(f"[MOCK] Invoice API running in mock mode - seeded {result['customers']} customers, {result['invoices']} invoices")
    else:
        log.info("[MOCK] Invoice API running in mock mode (data already exists)")
    if not s.INVOICE_TIER_ENFORCEMENT:
        log.info("[MOCK] Tier enforcement DISABLED - all features available")
```

---

### Railway Deployment

**Environment Variables (Main Backend):**
```
INVOICE_MOCK_MODE=true
INVOICE_TIER_ENFORCEMENT=false
```

**Production URL:**
```
https://web-production-3ed15.up.railway.app/api/integrations/invoice/health
```

**Test Endpoints:**
- Health: `GET /api/integrations/invoice/health`
- Customers: `GET /api/integrations/invoice/customers` (requires JWT)
- Invoices: `GET /api/integrations/invoice/invoices` (requires JWT)
- Stats: `GET /api/integrations/invoice/stats` (requires JWT)

---

### Frontend Integration

**IntegrationsPage.tsx** updates:
- Added Invoice Generator card with tier badge
- Shows feature availability based on subscription tier
- "Upgrade to Pro" button for free users
- "Open Invoice Generator" button navigates to `/dashboard/invoices`

**Subscription Hook (`useSubscription`):**
- Tracks user's subscription tier (free/pro)
- Provides feature flags: `createInvoices`, `manageCustomers`, `downloadPdf`, `exportData`
- Handles Stripe checkout and billing portal

---

### Switching to Production Mode

To switch from mock to real external Invoice API:

1. **Set environment variables:**
   ```env
   INVOICE_MOCK_MODE=false
   INVOICE_TIER_ENFORCEMENT=true
   INVOICE_API_URL=https://your-invoice-api.com
   INVOICE_API_KEY=your_api_key_here
   ```

2. **Redeploy** - No code changes needed, config-driven switch.

---

### Known Issues / Fixes Applied

1. **Route ordering conflict:** `/invoices/export` was being captured by `/invoices/{invoice_id}`. Fixed by moving export endpoint definition before parameterized route.

2. **Windows console encoding:** Unicode emojis caused `UnicodeEncodeError` on Windows. Fixed by replacing emojis with ASCII in `app/core/db.py`.

3. **Missing dependencies:** Required installing `bcrypt`, `python-jose[cryptography]`, `python-multipart`, `psycopg[binary]`.

---

### Testing Checklist

- [x] Server starts with mock mode enabled
- [x] Health endpoint returns mock status
- [x] Customers CRUD works
- [x] Invoices CRUD works
- [x] Stats endpoint returns calculated data
- [x] PDF download generates valid PDF
- [x] CSV export works
- [x] JWT authentication enforced on protected endpoints
- [x] Railway deployment successful

---

## Previous Implementations (Reference)

### Telegram Bot Integration
- Database migration for Telegram linking
- TelegramLinkCode model and User telegram fields
- Full bot handlers: /start, /status, /invoice, /verify, /sales, /promo, /help
- API Gateway deployed to Railway

### Stripe Subscription System
- Subscription model with tiers (free/pro)
- Stripe checkout and billing portal integration
- Feature gating for PDF/Export on Pro tier

### Rate Limiting & IP Management
- RateLimitMiddleware for API protection
- IP blocking/whitelisting system
- Violation tracking and automatic blocking

---

## Environment Summary

**Main Backend (Railway):**
- Service: facebook-automation
- URL: https://web-production-3ed15.up.railway.app
- Database: Supabase PostgreSQL

**Frontend (Vercel):**
- URL: https://facebooktiktokautomation.vercel.app

**API Gateway (Railway):**
- Telegram bot service
- URL: Separate Railway service

---

*Last updated: 2026-01-05*
